#!/bin/sh

echo "Installing pre-commit hooks..."
WORKDIR=$(mktemp -d)
PYENV_ROOT="$HOME/.pyenv"
trap 'rm -rf "$WORKDIR"' EXIT

setup() {
  # Check if pre-commit is installed
  if command -v pre-commit &> /dev/null; then
      echo "pre-commit is already installed. Exiting..."
      exit 0
  else
      echo "pre-commit not found. Installing pre-commit..."
      if ! pip install --user pre-commit; then
          echo "Error: Failed to install pre-commit." >&2
          exit 1
      fi
  fi
}

# Ensure pip or pip3 is installed. Otherwise, prompt the user to install Python
if ! command -v pip &> /dev/null && ! command -v pip3 &> /dev/null; then
    echo "pip or pip3 not found."
    echo "Checking pyenv installation..."
    if [ -d "$PYENV_ROOT" ]; then
        echo "pyenv found."
        # Temporarily load pyenv
        export PATH="$PYENV_ROOT/bin:$PATH"
        eval "$(pyenv init -)"

        # Use system Python
        pyenv global system
        pyenv rehash
        setup
    else
        echo "Error: pyenv not found. Please install pyenv first." >&2
        exit 1
    fi
else
    setup
fi
