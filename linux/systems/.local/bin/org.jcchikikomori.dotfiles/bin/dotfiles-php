#!/bin/sh

set -eu

script_dir() {
  script="$0"
  case "$script" in
    */*)
      path="$script"
      ;;
    *)
      path=$(command -v "$script" 2>/dev/null || printf '%s' "$script")
      ;;
  esac
  dir=$(dirname "$path")
  (CDPATH=; cd "$dir" 2>/dev/null && pwd) || pwd
}

SCRIPT_DIR=$(script_dir)

# THIS IS A BINARY/BASH SCRIPT TEMPLATE

if [ "$1" = "install" ]; then
  echo "Installing php using Homebrew..."
  if command -v brew >/dev/null 2>&1; then
    echo "Homebrew is installed and executable."
  else
    echo "Homebrew is not installed or not in PATH."
    echo "Installing homebrew..."
    if [ -x "${SCRIPT_DIR}/dotfiles-homebrew" ]; then
      "${SCRIPT_DIR}/dotfiles-homebrew" install
    elif command -v dotfiles-homebrew >/dev/null 2>&1; then
      dotfiles-homebrew install
    else
      echo "dotfiles-homebrew helper not found." >&2
      exit 1
    fi
  fi
  if ! command -v brew >/dev/null 2>&1; then
    for brew_bin in \
      "${HOMEBREW_PREFIX:-}/bin/brew" \
      "${HOME}/.linuxbrew/bin/brew" \
      "/home/linuxbrew/.linuxbrew/bin/brew"; do
      if [ -x "$brew_bin" ]; then
        eval "$("$brew_bin" shellenv)"
        break
      fi
    done
  fi
  if ! command -v brew >/dev/null 2>&1; then
    echo "Homebrew installation failed or brew not in PATH." >&2
    exit 1
  fi
  export HOMEBREW_NO_ANALYTICS=1
  export HOMEBREW_NO_ENV_HINTS=1
  # Install PHP 8.2 using Homebrew
  brew install php@8.2
elif [ "$1" = "env" ]; then
  echo "Install phpenv..."
  # Store current directory
  ORIGINAL_DIR=$(pwd)
  # Create a temporary working directory
  WORKDIR=$(mktemp -d)
  trap 'rm -rf "$WORKDIR"' EXIT
  # Change to temporary directory
  cd "$WORKDIR"
  # Download and extract libzip
  curl -L https://github.com/nih-at/libzip/releases/download/v1.7.3/libzip-1.7.3.tar.gz -o libzip-1.7.3.tar.gz &&
    tar -zxvf libzip-1.7.3.tar.gz &&
    cd libzip-1.7.3 &&
    cmake3 . -DCMAKE_INSTALL_PREFIX=/usr &&
    make &&
    sudo make install
  # Install phpenv
  git clone https://github.com/phpenv/phpenv.git ~/.phpenv
  export PATH="$HOME/.phpenv/bin:$PATH"
  eval "$(phpenv init -)"
  # Install php-build plugin
  git clone https://github.com/php-build/php-build $(phpenv root)/plugins/php-build
  # Return to original directory
  cd "$ORIGINAL_DIR"
  # Always the updated version of PHP, due to dependency issue on C compiler.
  # phpenv install 8.3.13
  phpenv rehash
else
  echo "Usage: $0 {install|env}"
  echo "  install: Install php using Homebrew (RECOMMENDED)"
  echo "  env: Install phpenv (Advanced)"
  exit 1
fi
