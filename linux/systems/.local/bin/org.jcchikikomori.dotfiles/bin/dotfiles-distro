#!/bin/sh

set -eu

DISTRO_FILE="${HOME}/.dotfiles-distro"

log() {
  printf '[dotfiles-distro] %s\n' "$*"
}

normalize_distro() {
  case "$1" in
    # separate ubuntu from this category, for stability reasons
    debian|pop|neon|raspbian)
      printf 'debian\n'
      ;;
    # ubuntu and other derivatives
    ubuntu|linuxmint|pop|zorin|kali)
      printf 'ubuntu\n'
      ;;
    fedora|centos|rhel|rocky|almalinux|oracle|scientific|sangoma)
      printf 'fedora\n'
      ;;
    arch|manjaro|endeavouros|garuda|arcolinux)
      printf 'arch\n'
      ;;
    steamos)
      printf 'steamos\n'
      ;;
    opensuse|suse|sled|sles|opensuse-leap|opensuse-tumbleweed)
      printf 'opensuse\n'
      ;;
    alpine)
      printf 'alpine\n'
      ;;
    gentoo)
      printf 'gentoo\n'
      ;;
    void)
      printf 'void\n'
      ;;
    clear-linux-os|clearlinux)
      printf 'clearlinux\n'
      ;;
    *)
      return 1
      ;;
  esac
}

detect_distro() {
  if [ -r /etc/os-release ]; then
    # shellcheck disable=SC1091
    . /etc/os-release
    for value in "${ID:-}" ${ID_LIKE:-}; do
      if distro=$(normalize_distro "$value"); then
        printf '%s\n' "$distro"
        return
      fi
    done
  fi

  if command -v lsb_release >/dev/null 2>&1; then
    if distro=$(normalize_distro "$(lsb_release -si 2>/dev/null | tr '[:upper:]' '[:lower:]')"); then
      printf '%s\n' "$distro"
      return
    fi
  fi

  if distro=$(normalize_distro "$(uname -s | tr '[:upper:]' '[:lower:]')"); then
    printf '%s\n' "$distro"
    return
  fi

  printf 'unknown\n'
}

write_distro_file() {
  distro=$(detect_distro)
  log "Detected distribution: ${distro}"
  printf '%s\n' "$distro" > "$DISTRO_FILE"
  log "Wrote ${DISTRO_FILE}"
}

usage() {
  echo "Usage: $0 {install|update}"
  echo "  install: Detect and store the current distribution"
  echo "  update: Refresh the detected distribution"
}

main() {
  if [ $# -eq 0 ]; then
    usage
    exit 1
  fi

  case "$1" in
    install|update)
      write_distro_file
      ;;
    *)
      usage
      exit 1
      ;;
  esac
}

main "$@"
